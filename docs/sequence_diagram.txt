+================================================================================+
|                         AI 封面生成器系统                                       |
|                    核心封面生成流程 - 序列图                                     |
+================================================================================+

说明：本图展示用户发起封面生成请求后，系统各组件的交互时序。
纵向为时间轴（从上到下），横向为不同组件的生命线。

参与者 PARTICIPANTS:
================================================================================
  [User/Browser]  [CoverGenerator]  [API/generate]  [Pipeline]  [TextAnalyzer]
   用户/浏览器       封面生成组件        API路由         生成管道      文本分析代理
                     (React)          (Route)        (Class)      (Agent)

  [TitleGenerator]  [ImageGenerator]  [OpenAI]  [Replicate]  [R2 Storage]
     标题生成代理       图片生成代理      OpenAI    Replicate    R2云存储
      (Agent)           (Agent)        (API)      (API)        (Cloud)

================================================================================
                            封面生成主流程 COVER GENERATION FLOW
================================================================================

[User/Browser]                                                              时间
用户/浏览器                                                                  TIME
     |                                                                        |
     |  1. 填写表单 (文本内容, 目标平台[], 风格模板)                            |
     |  2. 点击 "生成" 按钮                                                   |
     +--------------------------->                                            |
     |                           [CoverGenerator]                             |
     |                           封面生成组件                                  |
     |                                 |                                      |
     |                                 |  3. handleGenerate() 处理生成请求     |
     |                                 |     - 校验输入参数                    |
     |                                 |     - 设置状态为"generating"          |
     |                                 |                                      |
     |                                 |  4. POST /api/generate 发起API请求   |
     |                                 +------------------------>             |
     |                                 |                        [API/generate]|
     |                                 |                        API路由处理器  |
     |                                 |                              |       |
     |                                 |        5. withModeration()   |       |
     |                                 |           内容审核中间件      |       |
     |                                 |           - 检查内容合规性    |       |
     |                                 |           - checkRateLimit() |       |
     |                                 |             检查请求频率      |       |
     |                                 |           - validateRequest()|       |
     |                                 |             校验请求格式      |       |
     |                                 |                              |       |
     |                                 |        6. 创建任务 Create Job|       |
     |                                 |           jobId = uuidv4()   |       |
     |                                 |           生成唯一任务ID      |       |
     |                                 |           jobs.set(jobId)    |       |
     |                                 |           保存任务到内存Map   |       |
     |                                 |                              |       |
     |                                 |  7. 返回 {jobId} 任务ID       |       |
     |                                 |<------------------------+    |       |
     |                                 |                              |       |
     |                                 |        8. processJob() 异步处理任务    |
     |                                 |           [ASYNC BACKGROUND] |       |
     |                                 |           后台异步执行        |       |
     |                                 |              |              |       |
     |                                 |              +------------->|       |
     |                                 |                             |       |
     |                                 |                        [Pipeline]   |
     |                                 |                        生成管道     |
     |                                 |                             |       |
     |  9. pollProgress(jobId)         |                             |       |
     |     开始轮询任务进度              |                             |       |
     |     [Start polling loop]        |                             |       |
     |<--------------------------------+                             |       |
     |                                                               |       |
     +---------------------------------------------------------------+-------+
     |                                                               |
     |                    ===== 管道执行阶段 PIPELINE EXECUTION =====  |
     |                                                               |
     |                                                         [Pipeline]
     |                                                         生成管道
     |                                                               |
     |  步骤1: 文本分析 STEP 1: Text Analysis (权重: 20%)             |
     |  +-----------------------------------------------------------------+
     |  |                                                                 |
     |  |  10. textAnalyzer.analyzeText(text)                             |
     |  |      调用文本分析代理                                            |
     |  |      +------------------------------------------->              |
     |  |      |                                          [TextAnalyzer]  |
     |  |      |                                          文本分析代理     |
     |  |      |                                                |         |
     |  |      |           11. buildAnalysisPrompt(text)        |         |
     |  |      |               构建分析提示词                    |         |
     |  |      |               - 使用中文提示词模板              |         |
     |  |      |                                                |         |
     |  |      |           12. openai.generateText(prompt)      |         |
     |  |      |               调用OpenAI GPT-4                 |         |
     |  |      |               +-------------------------------->         |
     |  |      |               |                              [OpenAI]    |
     |  |      |               |                                  |       |
     |  |      |               |  13. GPT-4 分析文本内容          |       |
     |  |      |               |      返回JSON格式结果           |       |
     |  |      |               |<---------------------------------+       |
     |  |      |                                                |         |
     |  |      |           14. parseAnalysisResponse()          |         |
     |  |      |               解析分析响应                      |         |
     |  |      |               - 提取 keyPoints[] 关键点         |         |
     |  |      |               - 提取 sentiment 情感倾向         |         |
     |  |      |               - 提取 topics[] 主题标签          |         |
     |  |      |               - 提取 keywords[] 关键词          |         |
     |  |      |                                                |         |
     |  |      |<-----------------------------------------------|         |
     |  |      返回: TextAnalysisResult 文本分析结果                       |
     |  +-----------------------------------------------------------------+
     |                                                               |
     |  步骤2: 标题生成 STEP 2: Title Generation (权重: 30%)           |
     |  +-----------------------------------------------------------------+
     |  |                                                                 |
     |  |  15. 遍历每个平台 FOR EACH platform IN platforms[]:              |
     |  |      titleGenerator.generateTitles(text, analysis, platform)    |
     |  |      调用标题生成代理                                            |
     |  |      +-------------------------------------------->             |
     |  |      |                                        [TitleGenerator]  |
     |  |      |                                        标题生成代理       |
     |  |      |                                              |           |
     |  |      |         16. buildTitlePrompt()               |           |
     |  |      |             构建标题生成提示词                |           |
     |  |      |             - 平台特定的标题规范              |           |
     |  |      |             - 小红书/微信/抖音/B站 各有特色   |           |
     |  |      |                                              |           |
     |  |      |         17. openai.generateText(prompt)      |           |
     |  |      |             调用OpenAI GPT-4                 |           |
     |  |      |             +-------------------------------->           |
     |  |      |             |                              [OpenAI]      |
     |  |      |             |                                  |         |
     |  |      |             |  18. GPT-4 生成3-5个标题候选      |         |
     |  |      |             |      返回JSON格式标题列表        |         |
     |  |      |             |<---------------------------------+         |
     |  |      |                                              |           |
     |  |      |         19. parseTitlesResponse()            |           |
     |  |      |             解析标题响应                      |           |
     |  |      |             返回: GeneratedTitle[] 标题数组   |           |
     |  |      |<---------------------------------------------|           |
     |  |                                                                 |
     |  |  [Promise.all 等待所有平台的标题生成完成]                         |
     |  |  返回: titlesByPlatform[][] 按平台分组的标题                      |
     |  +-----------------------------------------------------------------+
     |                                                               |
     |  步骤3: 图片生成 STEP 3: Image Generation (权重: 45%)           |
     |  +-----------------------------------------------------------------+
     |  |                                                                 |
     |  |  20. 遍历每个平台 FOR EACH platform IN platforms[]:              |
     |  |      imageGenerator.generateImage({title, platform, template})  |
     |  |      调用图片生成代理                                            |
     |  |      +-------------------------------------------->             |
     |  |      |                                        [ImageGenerator]  |
     |  |      |                                        图片生成代理       |
     |  |      |                                              |           |
     |  |      |         21. buildImagePrompt()               |           |
     |  |      |             构建图片生成提示词                |           |
     |  |      |             - 平台风格描述符                  |           |
     |  |      |             - 模板颜色配置                    |           |
     |  |      |             - 图片质量要求                    |           |
     |  |      |                                              |           |
     |  |      |         22. selectProvider(platform)         |           |
     |  |      |             选择AI提供商                      |           |
     |  |      |             - B站/抖音 -> Replicate (更有创意)|           |
     |  |      |             - 其他平台 -> OpenAI DALL-E (专业)|           |
     |  |      |                                              |           |
     |  |      |         23a. [如果选择OpenAI]                 |           |
     |  |      |             generateWithOpenAI(prompt)       |           |
     |  |      |             使用DALL-E 3生成                  |           |
     |  |      |             +-------------------------------->           |
     |  |      |             |                              [OpenAI]      |
     |  |      |             |                                  |         |
     |  |      |             |  24a. DALL-E 3 生成图片          |         |
     |  |      |             |       尺寸: 1024x1024/1792x1024  |         |
     |  |      |             |       返回: imageUrl 图片URL     |         |
     |  |      |             |<---------------------------------+         |
     |  |      |                                              |           |
     |  |      |         23b. [如果选择Replicate]              |           |
     |  |      |             generateWithReplicate(prompt)    |           |
     |  |      |             使用Stable Diffusion生成          |           |
     |  |      |             +-------------------------------->           |
     |  |      |             |                            [Replicate]     |
     |  |      |             |                                  |         |
     |  |      |             |  24b. Stable Diffusion 生成图片  |         |
     |  |      |             |       返回: imageUrl 图片URL     |         |
     |  |      |             |<---------------------------------+         |
     |  |      |                                              |           |
     |  |      |         25. saveImageToR2(imageUrl)          |           |
     |  |      |             保存图片到R2云存储                 |           |
     |  |      |             - fetch(imageUrl) 下载图片        |           |
     |  |      |             - uploadToR2(buffer) 上传到R2     |           |
     |  |      |             +-------------------------------->           |
     |  |      |             |                            [R2 Storage]    |
     |  |      |             |                            R2云存储        |
     |  |      |             |                                  |         |
     |  |      |             |  26. 存储图片到Bucket            |         |
     |  |      |             |      返回: publicUrl 公开访问URL |         |
     |  |      |             |<---------------------------------+         |
     |  |      |                                              |           |
     |  |      |<---------------------------------------------+           |
     |  |      返回: r2ImageUrl 存储后的图片URL                            |
     |  |                                                                 |
     |  |  [Promise.all 等待所有平台的图片生成完成]                         |
     |  |  返回: imageUrls[] 图片URL数组                                   |
     |  +-----------------------------------------------------------------+
     |                                                               |
     |  步骤4: 组装结果 STEP 4: Assemble Results (权重: 5%)            |
     |  +-----------------------------------------------------------------+
     |  |                                                                 |
     |  |  27. 为每个平台构建 CoverGenerationResult[]:                     |
     |  |      {                                                          |
     |  |        id: uuidv4(),           // 结果唯一ID                     |
     |  |        platform: Platform,     // 平台信息                       |
     |  |        imageUrl: r2ImageUrl,   // 图片URL                       |
     |  |        thumbnailUrl: r2ImageUrl, // 缩略图URL                   |
     |  |        title: bestTitle.text,  // 最佳标题                       |
     |  |        metadata: {             // 元数据                         |
     |  |          fileSize,             // 文件大小                       |
     |  |          format,               // 文件格式                       |
     |  |          dimensions            // 图片尺寸                       |
     |  |        }                                                        |
     |  |      }                                                          |
     |  |                                                                 |
     |  |  28. 更新任务状态                                                |
     |  |      job.status = "completed"  // 状态: 已完成                   |
     |  |      job.results = results     // 保存结果                       |
     |  |      job.progress = 100        // 进度: 100%                    |
     |  +-----------------------------------------------------------------+
     |                                                               |
     +---------------------------------------------------------------+
     |
     |  ===== 客户端轮询阶段 POLLING LOOP (Client Side) =====
     |
[User/Browser]
用户/浏览器
     |
     |  29. GET /api/generate/{jobId}    [每1秒轮询一次]
     |      查询任务状态
     +------------------------------------------------------------------>
     |                                                    [API/generate]
     |                                                    API路由处理器
     |                                                          |
     |                    30. 返回任务状态:                      |
     |                        - status: "processing" 处理中     |
     |                        - progress: 45% 进度              |
     |<----------------------------------------------------------+
     |
     |  [继续轮询直到 status == "completed"]
     |
     |  31. GET /api/generate/{jobId}    [最后一次轮询]
     |      查询任务状态
     +------------------------------------------------------------------>
     |                                                          |
     |                    32. 返回已完成的任务:                   |
     |                        - status: "completed" 已完成       |
     |                        - results: CoverGenerationResult[] |
     |                          封面生成结果数组                  |
     |<----------------------------------------------------------+
     |
     |  33. setGenerationState({ status: "completed", results })
     |      更新前端状态为已完成
     |
     |  34. 在 CoverGallery / InfiniteCanvas 中展示结果
     |      用户可以预览、编辑、下载生成的封面
     |
     +  [流程结束 END]

================================================================================
                            错误处理流程 ERROR HANDLING FLOW
================================================================================

[Any Step Failure]
任意步骤失败
     |
     |  catch(error)
     |  捕获错误
     |      |
     |      v
     |  job.status = "failed"
     |  任务状态设为失败
     |  job.error = error.message
     |  保存错误信息
     |      |
     |      v
     |  [客户端继续轮询 GET /api/generate/{jobId}]
     |      |
     |      v
     |  返回: { status: "failed", error: "..." }
     |  返回失败状态和错误信息
     |      |
     |      v
     |  setGenerationState({ status: "error", error })
     |  更新前端状态为错误
     |      |
     |      v
     |  在 ErrorBoundary 组件中显示错误信息
     |  提供重试选项

================================================================================
                              图例说明 LEGEND
================================================================================

  [Component]     React组件 / 类实例
  (type)          组件类型标注
  ----->          同步调用
  - - - >         异步调用
  +--------+      处理块 / 步骤分组
  |        |
  +--------+

时序说明:
  - 纵向（从上到下）表示时间流逝
  - 每个步骤编号按执行顺序递增
  - 同一行内的多个组件表示并行处理

================================================================================
