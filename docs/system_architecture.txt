+================================================================================+
|                         AI 封面生成器系统                                       |
|                         系统架构图                                              |
+================================================================================+

说明：本图展示系统的分层架构，从用户界面到基础设施层的完整依赖关系。
箭头表示调用方向，从上层调用下层。

+--------------------------------------------------------------------------------+
|                              展示层 PRESENTATION LAYER                          |
|                              (Next.js App Router 路由)                          |
+--------------------------------------------------------------------------------+
|                                                                                |
|  +------------------------+  +------------------------+  +------------------+  |
|  |     /generate          |  |       /results         |  |   / (首页)       |  |
|  |   封面生成页面          |  |     结果展示页面        |  |   落地页         |  |
|  |   [page.tsx]           |  |     [page.tsx]         |  |   [page.tsx]     |  |
|  +----------+-------------+  +----------+-------------+  +--------+---------+  |
|             |                           |                         |            |
|  +----------v------------------------------------------------------------+     |
|  |                       组件层 COMPONENT LAYER (React 单页应用)           |     |
|  +-----------------------------------------------------------------------+     |
|  |                                                                       |     |
|  |  +------------------+  +------------------+  +---------------------+  |     |
|  |  | covers/          |  | forms/           |  | ui/                 |  |     |
|  |  | 封面业务组件      |  | 表单输入组件      |  | 通用UI组件          |  |     |
|  |  |                  |  |                  |  |                     |  |     |
|  |  | cover-generator  |  | text-input       |  | button, card        |  |     |
|  |  |   封面生成器      |  |   文本输入        |  |   按钮、卡片         |  |     |
|  |  | cover-editor     |  | style-selector   |  | dialog, progress    |  |     |
|  |  |   封面编辑器      |  |   风格选择器      |  |   对话框、进度条     |  |     |
|  |  | cover-gallery    |  | platform-selector|  | error-boundary      |  |     |
|  |  |   封面画廊        |  |   平台选择器      |  |   错误边界          |  |     |
|  |  | cover-display    |  +------------------+  +---------------------+  |     |
|  |  |   封面展示        |                                                |     |
|  |  | infinite-canvas  |                                                 |     |
|  |  |   无限画布        |                                                 |     |
|  |  | platform-preview |                                                 |     |
|  |  |   平台预览        |                                                 |     |
|  |  | property-panel   |                                                 |     |
|  |  |   属性面板        |                                                 |     |
|  |  +------------------+                                                 |     |
|  +-----------------------------------------------------------------------+     |
|                                                                                |
+-------------------------------+------------------------------------------------+
                                |
                                | HTTP API 调用 (JSON 格式)
                                v
+--------------------------------------------------------------------------------+
|                              接口层 API LAYER (Next.js Route Handlers)          |
|                              (服务端 API 路由处理器)                             |
+--------------------------------------------------------------------------------+
|                                                                                |
|  +-------------------------------------+  +----------------------------------+ |
|  | /api/generate                       |  | /api/generate/[jobId]            | |
|  | 封面生成接口                         |  | 任务状态查询接口                  | |
|  | [route.ts]                          |  | [route.ts]                       | |
|  |                                     |  |                                  | |
|  | POST: 启动封面生成任务               |  | GET: 轮询任务状态/获取结果        | |
|  | GET:  列出所有任务                   |  |                                  | |
|  +------------------+------------------+  +----------------+-----------------+ |
|                     |                                      |                   |
|  +------------------v--------------------------------------v-----------------+ |
|  |                        中间件层 MIDDLEWARE LAYER                          | |
|  |                        (请求预处理与安全控制)                              | |
|  +--------------------------------------------------------------------------+ |
|  |                                                                          | |
|  |  +-----------------------------+  +--------------------------------+     | |
|  |  | moderation-middleware.ts    |  | rate-limit-middleware.ts       |     | |
|  |  | 内容审核中间件               |  | 限流中间件                      |     | |
|  |  | - 内容过滤                   |  | - 请求节流                      |     | |
|  |  | - 拦截违规内容               |  | - 基于IP的访问频率限制           |     | |
|  |  +-----------------------------+  +--------------------------------+     | |
|  |                                                                          | |
|  +--------------------------------------------------------------------------+ |
|                                                                                |
+-------------------------------+------------------------------------------------+
                                |
                                v
+--------------------------------------------------------------------------------+
|                              业务逻辑层 BUSINESS LOGIC LAYER                    |
|                              (核心处理管道与AI代理)                              |
+--------------------------------------------------------------------------------+
|                                                                                |
|  +------------------------------------------------------------------------+   |
|  |                    封面生成管道 COVER GENERATION PIPELINE               |   |
|  |                    [cover-pipeline.ts]                                 |   |
|  |                    (编排多个AI代理完成封面生成)                          |   |
|  |                                                                        |   |
|  |   execute(request) / executeWithProgress(request, onProgress)          |   |
|  |   同步执行 / 带进度回调的执行                                           |   |
|  |                                                                        |   |
|  +----+---------------------+---------------------+-----------------------+   |
|       |                     |                     |                           |
|       v                     v                     v                           |
|  +-----------+       +------------+        +--------------+                   |
|  | 步骤 1    |       | 步骤 2     |        | 步骤 3       |                   |
|  | STEP 1    |       | STEP 2     |        | STEP 3       |                   |
|  | 文本分析   |------>| 标题生成   |------->| 图片生成     |                   |
|  | Analyze   |       | Generate   |        | Generate     |                   |
|  | Text      |       | Titles     |        | Images       |                   |
|  | 权重: 20% |       | 权重: 30%  |        | 权重: 45%    |                   |
|  +-----------+       +------------+        +--------------+                   |
|       |                     |                     |                           |
|  +----v---------------+----v---------------+-----v------------------+         |
|  |                    AI 代理层 AI AGENTS LAYER                     |         |
|  |                    (封装AI调用逻辑的智能代理)                     |         |
|  +------------------------------------------------------------------+         |
|  |                                                                  |         |
|  |  +------------------+  +------------------+  +------------------+ |         |
|  |  | TextAnalysisAgent|  | TitleGenAgent    |  | ImageGenAgent    | |         |
|  |  | 文本分析代理      |  | 标题生成代理      |  | 图片生成代理      | |         |
|  |  | [text-analyzer]  |  | [title-generator]|  | [image-generator]| |         |
|  |  |                  |  |                  |  |                  | |         |
|  |  | analyzeText()    |  | generateTitles() |  | generateImage()  | |         |
|  |  |   分析文本        |  |   生成标题        |  |   生成图片        | |         |
|  |  | buildPrompt()    |  | buildPrompt()    |  | buildPrompt()    | |         |
|  |  |   构建提示词      |  |   构建提示词      |  |   构建提示词      | |         |
|  |  | parseResponse()  |  | parseResponse()  |  | selectProvider() | |         |
|  |  |   解析响应        |  |   解析响应        |  |   选择AI提供商    | |         |
|  |  +--------+---------+  +--------+---------+  +--------+---------+ |         |
|  |           |                     |                     |           |         |
|  +-----------+---------------------+---------------------+-----------+         |
|              |                     |                     |                     |
|              +-----------+---------+-------+-------------+                     |
|                          |                 |                                   |
|                          v                 v                                   |
|              +-----------+----------+  +---+----------------------------+      |
|              | AI 提供商适配层       |  | 配置层 CONFIGURATION           |      |
|              | AI PROVIDERS         |  |                                |      |
|              | [providers/]         |  | platforms/specs.ts             |      |
|              | (统一AI服务接口)      |  |   平台规格配置 (10个社交平台)   |      |
|              |                      |  | data/templates.ts              |      |
|              | +------------------+ |  |   风格模板配置 (10种样式)       |      |
|              | | OpenAI Provider  | |  |                                |      |
|              | | OpenAI 提供商    | |  +--------------------------------+      |
|              | | - GPT-4 (文本)   | |                                          |
|              | | - DALL-E 3 (图像)| |                                          |
|              | +------------------+ |                                          |
|              | +------------------+ |                                          |
|              | | Gemini Provider  | |                                          |
|              | | Gemini 提供商    | |                                          |
|              | | - 多模态能力     | |                                          |
|              | +------------------+ |                                          |
|              | +------------------+ |                                          |
|              | | Replicate        | |                                          |
|              | | Replicate 提供商 | |                                          |
|              | | - Stable Diff.   | |                                          |
|              | +------------------+ |                                          |
|              +----------+-----------+                                          |
|                         |                                                      |
+-------------------------+------------------------------------------------------+
                          |
                          v
+--------------------------------------------------------------------------------+
|                           基础设施层 INFRASTRUCTURE LAYER                       |
|                           (外部服务与存储)                                       |
+--------------------------------------------------------------------------------+
|                                                                                |
|  +--------------------------------+  +--------------------------------------+  |
|  | 云存储 CLOUDFLARE R2 STORAGE   |  | 外部AI服务 EXTERNAL AI SERVICES      |  |
|  | [storage/r2.ts]                |  |                                      |  |
|  | (兼容S3的对象存储)              |  |  +-----------------------------+     |  |
|  |                                |  |  | OpenAI API                  |     |  |
|  | uploadToR2()   上传图片        |  |  | - api.openai.com            |     |  |
|  | getFromR2()    获取图片        |  |  | - GPT-4, DALL-E 3           |     |  |
|  | deleteFromR2() 删除图片        |  |  +-----------------------------+     |  |
|  |                                |  |  +-----------------------------+     |  |
|  | Bucket: ai-cover-generator     |  |  | Google AI API               |     |  |
|  | 存储桶名称                      |  |  | - generativelanguage.google |     |  |
|  +--------------------------------+  |  | - Gemini Pro                |     |  |
|                                      |  +-----------------------------+     |  |
|                                      |  +-----------------------------+     |  |
|                                      |  | Replicate API               |     |  |
|                                      |  | - api.replicate.com         |     |  |
|                                      |  | - Stable Diffusion          |     |  |
|                                      |  +-----------------------------+     |  |
|                                      +--------------------------------------+  |
|                                                                                |
+--------------------------------------------------------------------------------+

+================================================================================+
|                          支持的平台 SUPPORTED PLATFORMS (10个)                  |
+================================================================================+
|                                                                                |
|  社交类 SOCIAL:                                                                 |
|    小红书 (1:1 正方形)  |  小红书竖版 (9:16 竖屏)  |  抖音 (9:16 竖屏)            |
|    微博 (16:9 横屏)                                                             |
|                                                                                |
|  电商类 E-COMMERCE:                                                             |
|    淘宝/天猫 (1:1 正方形)  |  淘宝横版 (3:2 横屏)                                 |
|                                                                                |
|  内容类 CONTENT:                                                                |
|    微信公众号 (16:9 横屏)  |  公众号头图 (2.35:1 超宽)                            |
|    B站封面 (16:9 横屏)     |  知乎 (16:9 横屏)                                   |
|                                                                                |
+================================================================================+

+================================================================================+
|                           关键技术栈 KEY TECHNOLOGIES                           |
+================================================================================+
|                                                                                |
|  框架 FRAMEWORK:     Next.js 14 (App Router) + TypeScript 5.x                  |
|  AI/机器学习 AI/ML:  LangChain + OpenAI + Google Gemini + Replicate            |
|  画布 CANVAS:        Fabric.js 6.x (前端封面编辑器)                             |
|  存储 STORAGE:       Cloudflare R2 (兼容 AWS S3)                               |
|  UI组件 UI:          Radix UI + TailwindCSS + Framer Motion                    |
|  校验 VALIDATION:    Zod (TypeScript 运行时类型校验)                            |
|                                                                                |
+================================================================================+

图例说明 LEGEND:
  +--------+     模块/组件边界
  |        |
  +--------+

  -------->     调用/依赖方向

  [xxx.ts]      源代码文件名
